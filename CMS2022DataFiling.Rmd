---
title: "CMS MA 2022 Filing"
output: html_document
---

```{r LibrarySetup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

tdy <- format(as.Date(Sys.Date()),"%B %d, %Y")
library(readr)
library(tidyverse)
library(readxl)
library(janitor)
#Negate
`%!in%` = Negate(`%in%`)
```

# 2022 Medicare Benefits

Today's Date is `r tdy`.
The purpose of this document is to provide insight into the approved Medicare Advantage benefits for all organizations that submit a bid.  This information is all sourced from the Centers for Medicare & Medicaid Services website <https://www.cms.gov/>.
Specifically this information has been sourced from the Research, Statistics, Data & Systems page <https://www.cms.gov/Research-Statistics-Data-and-Systems/Research-Statistics-Data-and-Systems>.  

### **Data Contents**

##### **Monthly Enrollment Information**
This file provides monthly enrollment at the contract/plan/state/county level for all organization types.  
Obtained from <https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/MCRAdvPartDEnrolData/Monthly-Enrollment-by-Contract-Plan-State-County>

The two main files included in this are:  

##### CPSC_Contract_Info_YYYY_MM.csv.  Columns include:  

* Contract ID - [text] - The contract identifier
* Plan ID - [text] - The plan identifier
* Organization Type - [text] - The type of contract held by the organization with CMS
* Plan Type  - [text] - The type of plan offered to beneficiaries
* Offers Part D - [text] - "Yes" = offers Part D benefit, "No" = does not offer Part D benefit
* SNP Plan - [text] - "Yes" = Special Needs Plan, "No" = not a Special Needs Plan
* EGHP - [text] - "Yes" = Employer Group Health Plan, "No" = not an Employer Group Health Plan 
* Organization Name - [text] - The name of the organization
* Organization Marketing Name - [text] - The name of the organization markets to beneficiaries
* Plan Name - [text] - The name of the plan created by the organization
* Parent Organization - [text] - the name of the parent organization for this contract
* Contract Effective Date - [date/time] - the data the contract began with CMS (in mm/dd/yyyy h:mm format) 
  
##### CPSC_Enrollment_YYYY_MM.csv Columns include:

* Contract ID - [text] - The contract identifier 
* Plan ID - [text] - The plan identifier
* SSA Code - [text] - The Social Security state/county code
* FIPS Code - [text] - The American National Standards Institue (ANSI) state/county code
* State - [text] - The two letter postal code for the state
* county - [text] - The name of the county
* Enrollment - [text] - Number of beneficiaries enrolled in the contract/plan/state/county (* = 10 or less)

##### **Quarterly Plan Benefit Package** 
Obtained from <https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/MCRAdvPartDEnrolData/Benefits-Data>

This file contains the following, with all pbp_ files below being specific to benefits.  The meal benefit fiel that we will focus on is pbp_b13_other_services.txt, which includes those "other" services.

* The PlanArea.txt file is available for Local MA and EDPDP-FB plans; the PlanRegionArea.txt file is available for Regional MA plans and PDPs.

1. pbp_SectionA.txt - Contains general plan information.
2. pbp_b1a_inpat_hosp.txt, pbp_b1b_inpat_hosp.txt - Inpatient Hospital Acute/Psychiatric data.
3. pbp_b2_snf.txt - Skilled Nursing Facility data.
4. pbp_b3_cardiac_rehab.txt - Cardiac and Pulmonary Rehabilitation data.
5. pbp_b4_emerg_urgent.txt - Emergency/Urgent Care data.
6. pbp_b5_partial_hosp.txt - Partial Hospitalization data.
7. pbp_b6_home_health.txt - Home Health data.
8. pbp_b7_health_prof.txt - Contains Health Care Professional data for Primary Care Physician, Chiropractic, occupational Therapy, Physician Specialist and Mental Health Specialist services.
9. pbp_b8_clin_diag_ther.txt - Outpatient Clinical, Diagnostic, and Therapeutic Radiology services data.
10. pbp_b9_outpt_hosp.txt - Outpatient Hospital, ASC, Outpatient Substance Abuse, and Cardiac Rehabilitation data.
11. pbp_b10_amb_trans.txt - Ambulance/Transportation data.
12.pbp_b11_dme_prosth_orth_sup.txt - Durable Medical Equipment, Prosthetics/Orthotics and Medical Supplies data.
13. pbp_b12_renal_dialysis.txt - Renal Dialysis data.
14. pbp_b13_other_services.txt - Outpatient Blood, Acupuncture and "Other" services data. The "Other" data describes benefits not included in standard PBP service categories.
15. pbp_b14_preventive.txt - Contains Preventive Services data for Health Education/Wellness, Immunizations, Routine Physicals, and Pap/Pelvic Exams.
16. pbp_b15_partb_rx_drugs.txt -  Medicare Part B prescription drugs.
17. pbp_b16_dental.txt - Preventive and Comprehensive Dental data.
18. pbp_b17_eye_exams_wear.txt - Eye Exams and Eye Wear data.
19. pbp_b18_hearing_exams_aids.txt - Hearing Exams and Hearing Aids data.
20. pbp_b20.txt - Contains enhanced Prescription Drug data for Cost Plans if they do NOT offer Part D drug benefits.
21. pbp_Section_C.txt - Contains Out-of-Network data for PPO plans.
22. pbp_section_c_oon.txt - Out-of-Network
23. pbp_section_c_pos.txt - Point of Service
24. pbp_Section_D.txt - Contains plan-level financial data such as plan premiums, global max plan benefit and out-of-pocket limits, and global deductibles.
25. pbp_section_D_oon.txt - Contains plan-level out-of-network deductibles and out-of-pocket limits.
26. pbp_Section_D_opt.txt - Contains plan-level benefit data descriptions of optional supplemental offerings including the optional benefit premium amounts.
27. pbp_mrx.txt - Contains Medicare Part D prescription drug benefits data.
28. pbp_mrx_gapCoverage.txt - Contains information on coverage of either tier(s) or specific drugs through the entire gap (ICL to catastrophic).
29. pbp_mrx_p.txt - Contains Medicare Part D prescription drug benefits (post OOP threshold) data.
30. pbp_mrx_tier.txt - Contains Medicare Part D prescription drug benefits (tiering) data.
31. pbp_step10b.txt - Contains step-up transportation benefit data.
32. pbp_step16a.txt - Contains step-up preventive dental data.
33. pbp_step16b.txt - Contains step-up comprehensive data.
34. pbp_step17a.txt - Contains step-up eye exams data.
35. pbp_step17b.txt - Contains step-up eye wear data.
36. pbp_step18a.txt - Contains step-up hearing exams data.
37. pbp_step18b.txt - Contains step-up hearing aids data.
38. pbp_step7b.txt - Contains step-up chiropractic benefit data.
39. pbp_step7f.txt - Contains step-up podiatry benefit data.

* planarea.txt and planRegionArea.txt - Contains Service Area data by plan (includes EGHP service areas).

*If you are importing the data into Excel, you must define certain columns as text or you will lose any leading zero information (example, a plan id of '001' will 
appear as '1' if defined as "general" or "numeric.").  The variable names for the columns that should be delineated as text (or character in SAS terminology) are 
provided within the SAS input statements as well as the PBP_Benefits_2022_dictionary.xlsx.*  

*The CY 2022 PBP Benefits file provides the universe of PBP data for all active contracts and contains all the approved benefit and financial data submitted as part of the CY 2022 Bid Submission by Medicare Advantage and Part D organizations, including those involved in certain demonstration projects and cost plans. The PBP Benefits file is updated quarterly.*


##### STARS RATINGS <https://www.cms.gov/medicare/prescription-drug-coverage/prescriptiondrugcovgenin/performancedata.html>  
The MA star ratings data are available as part of the Part C and D Performance Data. The data are not in a good analytical format and the variable names differ over time. In the associated code files, I've renamed variables so that sufficiently similar data are given the same name across all years of data

```{r Load Enrollment Info, echo=FALSE, message=FALSE}
y <- 2021 ## Year 
m <- "10" ## Month of Enrollment

enrollment.path <- paste0("C:/Users/eyankowski/OneDrive - momsmeals.com\\MM\\CMS\\CPSC\\CPSC_Enrollment_",y,"_",m,"\\")

ContractInfo   <- paste0(enrollment.path,"CPSC_Contract_Info_",y,"_",m,".csv")
CPSC_Contract_Info <- read_csv(ContractInfo,
  col_types = cols(`Contract Effective Date` = col_date(format = "%m/%d/%Y")))%>%
  clean_names()%>%
  mutate(LINK=str_c(contract_id,plan_id,sep = "_"))


EnrollmentInfo <- paste0(enrollment.path,"CPSC_Enrollment_Info_",y,"_",m,".csv")
CPSC_Enrollment_Info <- read_csv(EnrollmentInfo,
  col_types = cols(Enrollment = col_number(),
  `Plan ID`=col_character()))%>%
  clean_names()%>% replace_na(list(enrollment = 0))%>%
  mutate(LINK=str_c(contract_number,plan_id,sep = "_"))

PlanLevelEnrollment <- CPSC_Enrollment_Info %>%
  group_by(LINK)%>%
  summarise(TotalMembers=sum(enrollment))%>%
  left_join(CPSC_Contract_Info)%>%
  filter(organization_type !='Medicare Prescription Drug Plan')%>%
  select(LINK,TotalMembers,contract_id,plan_id,snp_plan,eghp,
         organization_name,organization_marketing_name,plan_name,parent_organization)%>%
  mutate(PlanType=if_else(eghp=="Yes","Group",
                      if_else(snp_plan=="Yes","SNP","MAPD")))

EnrollmentByType <- PlanLevelEnrollment %>%
  group_by(PlanType)%>%
  summarise(Enrollment=sum(TotalMembers))%>%
  adorn_totals()

OverallEnrollment <- PlanLevelEnrollment %>% #prescription drug plans removed above
  group_by(organization_marketing_name)%>%
  summarise(Enrollment=sum(TotalMembers))%>%
  arrange(desc(Enrollment))%>%
  adorn_totals()

Top10Plans <- OverallEnrollment %>%
  slice(1:10)
Top10Plans.v <- as.vector(Top10Plans$organization_marketing_name)

```


```{r Health Plan Level, echo=FALSE, message=FALSE}


UHC <- CPSC_Enrollment_Info %>%
  group_by(LINK)%>%
  summarise(TotalMembers=sum(enrollment))%>%
  left_join(CPSC_Contract_Info)%>%
  filter(organization_type !='Medicare Prescription Drug Plan')%>%
  filter(organization_marketing_name=='UnitedHealthcare')%>%
  mutate(PlanType=if_else(eghp=="Yes","Group",
                      if_else(snp_plan=="Yes","SNP","MAPD")))%>%
  #filter(Type=="MAPD")%>%
  group_by(PlanType)%>%
  summarise(Enrollment=sum(TotalMembers))%>%
  adorn_totals()


UHC.contract <- CPSC_Enrollment_Info %>%
  group_by(LINK)%>%
  summarise(TotalMembers=sum(enrollment))%>%
  left_join(CPSC_Contract_Info)%>%
  filter(organization_type !='Medicare Prescription Drug Plan')%>%
  filter(organization_marketing_name=='UnitedHealthcare')%>%
  group_by(contract_id)%>%
  summarize(TotalEnrollment=sum(TotalMembers))%>%
  arrange(-TotalEnrollment)

UHC.type <- CPSC_Enrollment_Info %>%
  group_by(LINK)%>%
  summarise(TotalMembers=sum(enrollment))%>%
  left_join(CPSC_Contract_Info)%>%
  filter(organization_type !='Medicare Prescription Drug Plan')%>%
  filter(organization_marketing_name=='UnitedHealthcare')%>%
   mutate(PlanType=if_else(eghp=="Yes","Group",
                      if_else(snp_plan=="Yes","SNP","MAPD")))%>%
  group_by(PlanType)%>%
  summarise(Enrollment=sum(TotalMembers))%>%
  adorn_totals()

Humana <- CPSC_Enrollment_Info %>%
  group_by(LINK)%>%
  summarise(TotalMembers=sum(enrollment))%>%
  left_join(CPSC_Contract_Info)%>%
  filter(organization_type !='Medicare Prescription Drug Plan')%>%
  filter(organization_marketing_name=='Humana')%>%
  mutate(PlanType=if_else(eghp=="Yes","Group",
                      if_else(snp_plan=="Yes","SNP","MAPD")))%>%
  group_by(PlanType)%>%
  summarise(Enrollment=sum(TotalMembers))%>%
  adorn_totals()

Aetna <- CPSC_Enrollment_Info %>%
  group_by(LINK)%>%
  summarise(TotalMembers=sum(enrollment))%>%
  left_join(CPSC_Contract_Info)%>%
  filter(organization_type !='Medicare Prescription Drug Plan')%>%
  filter(organization_marketing_name=='Aetna Medicare')

Aetna.type <- CPSC_Enrollment_Info %>%
  group_by(LINK)%>%
  summarise(TotalMembers=sum(enrollment))%>%
  left_join(CPSC_Contract_Info)%>%
  filter(organization_type !='Medicare Prescription Drug Plan')%>%
  filter(organization_marketing_name=='Aetna Medicare')%>%
  mutate(PlanType=if_else(eghp=="Yes","Group",
                      if_else(snp_plan=="Yes","SNP","MAPD")))%>%
  group_by(PlanType)%>%
  summarise(Enrollment=sum(TotalMembers))%>%
  adorn_totals()
```

```{r Major Plan, echo=FALSE, message=FALSE}
major_plans <- CPSC_Enrollment_Info %>%
  group_by(LINK)%>%
  summarise(TotalMembers=sum(enrollment))%>%
  left_join(CPSC_Contract_Info)%>%
  filter(organization_type !='Medicare Prescription Drug Plan')%>%
  filter(organization_marketing_name %in% Top10Plans.v)%>%
  #filter(organization_marketing_name %in% c('Humana','Aetna Medicare','UnitedHealthcare'))%>%
  mutate(PlanType=if_else(eghp=="Yes","Group",
                      if_else(snp_plan=="Yes","SNP","MAPD")))%>%
  group_by(PlanType,organization_marketing_name)%>%
  summarise(Enrollment=sum(TotalMembers))%>%
  pivot_wider(names_from = organization_marketing_name,
              values_from = Enrollment)%>%
  adorn_totals()

```

```{r Filing Info, echo=FALSE, message=FALSE}

filingyear <- 2022 ## Year 

filing.path <- paste0("C:/Users/eyankowski/OneDrive - momsmeals.com\\MM\\CMS\\PBPData\\",filingyear,"\\PBP_Benefits_",filingyear,"\\")

SectionA_Info <- paste0(filing.path,"pbp_Section_A.txt")

SectionA  <- read_delim(SectionA_Info, 
     "\t", escape_double = FALSE, col_types = cols(pbp_a_last_data_entry_date = col_date(format = "%m/%d/%Y"), pbp_a_plan_identifier = col_character()), trim_ws = TRUE)%>%  select(pbp_a_hnumber,pbp_a_org_name,pbp_a_org_marketing_name,pbp_a_plan_name
                                                       ,pbp_a_plan_identifier...2
                                                       ,pbp_a_contract_number
                                                       ,pbp_a_segment_id
                                                       ,pbp_a_contract_period
                                                       ,pbp_a_plan_geog_name
                                                       ,pbp_a_segment_name
                                                       ,segment_id
                                                       ,pbp_a_plan_name
                                                       ,pbp_a_plan_type...5
                                                       ,pbp_a_special_need_flag
                                                       ,pbp_a_special_need_plan_type
                                                       ,pbp_a_dsnp_zerodollar
                                                       ,pbp_a_snp_cond
                                                       ,pbp_a_special_need_plan_type
                                                       ,pbp_a_dsnp_zerodollar
                                                       ,pbp_a_snp_institutional_type
                                                       ,pbp_a_est_memb
                                                       #,pbp_a_snp_pct#What percentage is SNP Eligible. All are exclusive
                                                       ,pbp_a_snp_state_cvg_yn
                                                       ,bid_id
                                                        ,version
                                                        ,pbp_a_last_data_entry_date)%>%
  mutate(SNP=if_else(pbp_a_special_need_flag==1,"Yes","No"),
         SNPType=case_when(pbp_a_special_need_plan_type==1~"Institutional",
                           pbp_a_special_need_plan_type==3~"Dual-Eligible",
                           pbp_a_special_need_plan_type==4~"Chronic or Disabling Condition"),
         TYPE=case_when(
    pbp_a_plan_type...5 %in% c("01","02","03","04","05","07","08","09",
                               "31","32","42","43","44","45","48","49")~"MA",#93
    pbp_a_plan_type...5=='29'~"Drug Plan",
    pbp_a_plan_type...5 %in% c('18','19')~"Cost Plans",
    pbp_a_plan_type...5=='20'~"National Pace",
    pbp_a_plan_type...5=='30'~"Employer_Union Direct Contact PDP",
    pbp_a_plan_type...5=='40'~"Employer_Union Direct Contact FFS",
    pbp_a_plan_type...5=='47'~"Employer Direct PPO"),#20 DIGITS EACH
    ChronicConditions=case_when(pbp_a_snp_cond=="00000000000000000001"~"Cardiovascular Disorders and/or Stroke", #20
                                pbp_a_snp_cond=="00000000000000000010"~"Cardiovascular Disorders, Chronic Heart Failure, and/or Diabetes", #19
                                pbp_a_snp_cond=="00000000000000000100"~"Chronic Heart Failure and/or Diabetes",#18
                                pbp_a_snp_cond=="00000000000000001000"~"Cardiovascular Disorders and/or Diabetes",#17
                                pbp_a_snp_cond=="00000000000000010000"~"Cardiovascular Disorders and/or Chronic Heart Failure",#16
                                pbp_a_snp_cond=="00000000000000100000"~"Stroke",#15
                                pbp_a_snp_cond=="00000000000001000000"~"Neurologic disorders",#14
                                pbp_a_snp_cond=="00000000000010000000"~"Chronic and disabling mental health conditions",#13
                                pbp_a_snp_cond=="00000000000100000000"~"Chronic lung disorders",#12
                                pbp_a_snp_cond=="00000000001000000000"~"HIV/AIDS",#11
                                pbp_a_snp_cond=="00000000010000000000"~"Severe hematologic disorders",#10
                                pbp_a_snp_cond=="00000000100000000000"~"Dialysis Services requiring dialysis (any mode of dialysis)",#9
                                pbp_a_snp_cond=="00000001000000000000"~"End-stage liver disease",#8
                                pbp_a_snp_cond=="00000010000000000000"~"Diabetes mellitus",#7
                                pbp_a_snp_cond=="00000100000000000000"~"Dementia",#6
                                pbp_a_snp_cond=="00001000000000000000"~"Chronic heart failure",#5
                                pbp_a_snp_cond=="00010000000000000000"~"Cardiovascular disorders",#4
                                pbp_a_snp_cond=="00100000000000000000"~"Cancer excluding pre-cancer conditions or in-situ status",#3
                                pbp_a_snp_cond=="01000000000000000000"~"Autoimmune disorders",#2
                                pbp_a_snp_cond=="100000000000000000000"~"Chronic alcohol and other drug dependence",#1,
                                pbp_a_snp_cond=="00011010000000000000"~"Cardiovascular_Chronic Heart Failure_Diabetes",))%>%
  select(pbp_a_hnumber,pbp_a_plan_identifier...2,pbp_a_segment_id,
         pbp_a_plan_geog_name,pbp_a_plan_name,pbp_a_est_memb,
         SNP,SNPType,TYPE,ChronicConditions,pbp_a_org_name,pbp_a_org_marketing_name,pbp_a_plan_name)%>%
  mutate(LINK=str_c(pbp_a_hnumber,pbp_a_plan_identifier...2,sep = "_"))

#FILING PATH
FilingPath.read   <- paste0(filing.path,"CPSC_Contract_Info_",y,"_",m,".csv")
CPSC_Contract_Info <- read_csv(ContractInfo,
  col_types = cols(`Contract Effective Date` = col_date(format = "%m/%d/%Y")))%>%
  clean_names()%>%
  mutate(LINK=str_c(contract_id,plan_id,sep = "_"))

#meal benefit
Meal_Info <- paste0(filing.path,"pbp_b13_other_services.txt")
BenefitInfo <- read_delim(Meal_Info, delim = "\t", escape_double = FALSE, 
                                          trim_ws = TRUE)%>%
  select(pbp_a_hnumber,pbp_a_plan_identifier,segment_id,
         pbp_b13c_meal_type_chk#type of health meals offered
         ,pbp_b13c_bendesc_amo#type of benefit, 2 is Mandatory, 3 is Optional
         ,pbp_b13c_bendesc_service#Meals 1 is Yes, 2 is No
         ,pbp_b13c_maxplan_amt #Indicate Maximum Plan Benefit Coverage amount:
         ,pbp_b13c_maxplan_yn #Is there a service-specific Maximum Plan Benefit Coverage amount?
        # ,pbp_b13c_auth_yn
        # ,pbp_b13c_refer_yn
         ,pbp_b13c_maxplan_per #Select Maximum Plan Benefit Coverage periodicity:
        )%>%
  mutate(CPBP=paste0(pbp_a_hnumber,"_",pbp_a_plan_identifier,"_",segment_id),
         LINK=str_c(pbp_a_hnumber,pbp_a_plan_identifier,sep = "_"),
         Meals=if_else(pbp_b13c_bendesc_service==1,"Yes","No"),
         BenefitType=if_else(pbp_b13c_bendesc_amo==2,"Mandatory","Optional"),
         MealBenefitMax=if_else(pbp_b13c_maxplan_yn==1,"Yes","No"),
         Period=case_when(
          pbp_b13c_maxplan_per ==3~"Every Year",
          pbp_b13c_maxplan_per ==6~"Other_Describe"),
         Benefit=case_when(
           pbp_b13c_meal_type_chk=='001'~"Chronic Illness",#93
           pbp_b13c_meal_type_chk=='010'~"Post Discharge",#2,032
           pbp_b13c_meal_type_chk=='011'~"PD and Chronic",#574
           pbp_b13c_meal_type_chk=='100'~"Medical Condition requiring home stay",#76
           pbp_b13c_meal_type_chk=='101'~"Medical Condition or Chronic",#13
           pbp_b13c_meal_type_chk=='110'~"Medical Condition or PD",#72
           pbp_b13c_meal_type_chk=='111'~"Medical Condition_PD_CC"))%>%#177),
      #  AuthRequired=if_else(pbp_b13c_auth_yn==1,"Yes","No"),
      #  ReferralRequired=if_else(pbp_b13c_refer_yn==1,"Yes","No"))%>%
  select(-pbp_b13c_bendesc_service,-pbp_b13c_maxplan_yn,-pbp_b13c_maxplan_per,-pbp_b13c_meal_type_chk,
         -pbp_b13c_bendesc_amo)

FullBenefitInfo <- BenefitInfo %>%
  left_join(PlanLevelEnrollment,by = c("LINK"))%>%
  left_join(SectionA,by = c("LINK"))%>%
  #filter(Type=="MAPD")%>%
  distinct(CPBP, .keep_all = T)%>%
  replace_na(list(SNPType = "Not SNP", ChronicConditions = "None",
                  Meals="No",Benefit="None",BenefitType="None",
                  Period="Unknown"))%>%
  select(-pbp_a_hnumber.y,-pbp_a_plan_identifier...2,-pbp_a_segment_id)

DuplicateCheck <- BenefitInfo2%>% group_by(CPBP)%>% summarize(n=n())%>%filter(n>1)%>%arrange(-n)

```

```{r Overall Numbers, echo=F, message=F}

Membership.Individual <- FullBenefitInfo %>%
  filter(SNP!='No')%>%
  group_by(Meals)%>%
  summarise(Plans=n(),
            Enrollment=sum(TotalMembers, na.rm = T))%>%
  mutate(Perc.enrollment=Enrollment/sum(Enrollment),
         Perc.plans=Plans/sum(Plans))

Membership.SNP <- FullBenefitInfo %>%
  filter(SNP=='Yes')%>%
  group_by(Meals)%>%
  summarise(Plans=n(),
            Enrollment=sum(TotalMembers, na.rm = T))%>%
  mutate(Perc.enrollment=Enrollment/sum(Enrollment),
         Perc.plans=Plans/sum(Plans))

Membership.Group <- FullBenefitInfo %>%
  filter(PlanType=='Group')%>%
  group_by(Meals)%>%
  summarise(Plans=n(),
            Enrollment=sum(TotalMembers, na.rm = T))%>%
  mutate(Perc.enrollment=Enrollment/sum(Enrollment),
         Perc.plans=Plans/sum(Plans))

MAPD.Plan <- FullBenefitInfo %>%
  drop_na(Meals)%>%
  filter(PlanType=='MAPD')%>%
  group_by(parent_organization,Meals)%>%
  summarise(Enrollment=sum(TotalMembers, na.rm = T))%>%
  pivot_wider(names_from = Meals,values_from = Enrollment,values_fill = 0)%>%
  mutate(Total=Yes+No,
         Eligible=round(Yes/Total,4))%>%
  arrange(-Total)

TypeOfPlan  <- FullBenefitInfo %>%
  #drop_na(Meals)%>%
  group_by(PlanType,Meals)%>%
  summarise(Enrollment=sum(TotalMembers, na.rm = T))%>%
  pivot_wider(names_from = Meals,values_from = Enrollment,values_fill = 0)%>%
  mutate(Total=Yes+No,
         Eligible=round(Yes/Total,4))%>%
  arrange(-Total)%>%
  adorn_totals()

InstitutionalSNP <- FullBenefitInfo %>%
  drop_na(Meals)%>%
  filter(SNPType=='Institutional')%>%
  group_by(SNPType,Meals)%>%
  summarise(Enrollment=sum(TotalMembers, na.rm = T))%>%
  pivot_wider(names_from = Meals,values_from = Enrollment,values_fill = 0)%>%
  mutate(Total=Yes+No,
         Eligible=round(Yes/Total,4))%>%
  arrange(-Total)

SNPSummary <- FullBenefitInfo %>%
  drop_na(Meals)%>%
  group_by(SNPType,Meals)%>%
  summarise(Enrollment=sum(TotalMembers, na.rm = T))%>%
  pivot_wider(names_from = Meals,values_from = Enrollment,values_fill = 0)%>%
  mutate(Total=Yes+No,
         Eligible=round(Yes/Total,4))%>%
  arrange(-Total)


```

# 2022 STARS Ratings

The STARS Ratings data is sourced from 
<https://www.cms.gov/Medicare/Prescription-Drug-Coverage/PrescriptionDrugCovGenIn/PerformanceData>.  

### **Pieces to Inspect a bit more**

SNP = YES does mean dual. Would need to do a bit of a cross check to ensure that no dual plan shares a H number with a traditional MA plan.
For the sake of looking at STAR ratings, we are only focused on the C or overall measures. D is specifically drug measures.


```{r STARS Ratings, echo=FALSE, message=FALSE}
y <- 2021 ## Year 
m <- "10" ## Month of Enrollment

STARS.Path <- paste0("C:/Users/eyankowski/OneDrive - momsmeals.com\\MM\\CMS\\2022 Star Ratings Data Table (Oct 06 2021)","\\")
STARS.Path   <- paste0(STARS.Path,"2022 Star Ratings Data Table - Summary Rating (Oct 06 2021)",".csv") 

Star_Ratings <- read_csv(STARS.Path,skip = 1)%>%
  clean_names()%>%
  select(1:6,9:11)


```

```{r County Penetration, echo=FALSE, message=FALSE}

y <- 2021 ## Year 
m <- "10" ## Month of Enrollment

InitialPenetration.Path <- paste0("C:/Users/eyankowski/OneDrive - momsmeals.com\\MM\\CMS\\State_County_Penetration","\\","State_County_Penetration_MA_",y,"_",m,"\\")
Penetration.Path   <- paste0(InitialPenetration.Path,"State_County_Penetration_MA_",y,"_",m,".csv") 

CountyPenetration <- read_csv(Penetration.Path, 
   col_types = cols(Enrolled = col_number(), 
        Penetration = col_number()))%>%
  clean_names()%>%
  filter(county_name!='Pending County Designation')%>%
  filter(state_name!='Pending State Designation')%>%
  mutate(PenetrationPerc=enrolled/eligibles)

```

```{r MACVAT Creation, echo=F,message=F}

CPSC_Members <- CPSC_Enrollment_Info %>%
  filter(enrollment>0)

MACVAT <- FullBenefitInfo %>%
  filter(TYPE=='MA')%>%
  filter(PlanType!='Group')%>%
  #slice(1:1000)%>%
  left_join(CPSC_Members,by = c("LINK"))%>%
  #select(-MealBenefitMax,-Period,-pbp_a_hnumber.x,-pbp_b13c_maxplan_amt,-snp_plan,-eghp,-pbp_a_plan_geog_name,-pbp_a_plan_name)%>%
  select(HPLAN=pbp_a_hnumber.x,`plan_id`=pbp_a_plan_identifier,
         segment_id,
         CPBP,LINK,Meals,BenefitType,Benefit,`PlanMembers`=TotalMembers,
         pbp_a_org_name,
         organization_name,
          pbp_a_org_marketing_name,
         organization_marketing_name,
         parent_organization,
         PlanType,
         `Projected22Membership`=pbp_a_est_memb,
         SNP,SNPType,TYPE,ChronicConditions,ssa_state_county_code,
         fips_state_county_code,state,county,`county_enrollment`=enrollment)%>%
  left_join(Star_Ratings,by = c("HPLAN"="contract_number"))%>%
  left_join(CountyPenetration,by = c("ssa_state_county_code"="ssa"))
        
test1 <- MACVAT %>%
  filter(CPBP=='H0022_001_0')

cuyahoga <- MACVAT %>% filter(county=='Geauga')%>%
  group_by(PlanType)%>%
  distinct(CPBP,.keep_all = T)%>%
  summarize(n=n(),
            Members=sum(county_enrollment))
```

